  基于代码探索，以下是粒子系统的完整架构：

  1. 目录结构

  source/runtime/asset/
  ├── particle/                          # 核心粒子系统
  │   ├── particle_system.h/cpp          # 顶层容器
  │   ├── particle_emitter.h/cpp         # 发射器
  │   ├── particle_modules.h/cpp         # 模块系统
  │   └── function/                      # 功能函数
  │       ├── emitter/                   # 发射器级函数
  │       ├── context/                   # 系统级函数
  │       └── math/                      # 参数化系统（曲线、标量等）
  └── material/particle/                 # 粒子材质节点

  2. 核心类层次

  | 类名              | 文件                 | 职责             |
  |-----------------|--------------------|----------------|
  | ParticleSystem  | particle_system.h  | 顶层容器，管理所有发射器   |
  | ParticleContext | particle_system.h  | 系统级参数和模块       |
  | ParticleEmitter | particle_emitter.h | 单个发射器，管理粒子生命周期 |
  | Particle        | particle_emitter.h | 单个粒子的数据结构      |

  3. 粒子数据结构

  struct Particle {
      Vec3 position;           // 本地位置
      Vec3 world_pos;          // 世界位置
      Vec3 velocity;           // 速度
      Vec4 init_color / color; // 初始/当前颜色
      Vec2 init_size / size;   // 初始/当前尺寸
      Scalar age / life;       // 当前年龄/生命周期
      Scalar rotation;         // 旋转角度
      Vec3 force;              // 当前帧的力
      // ...
  };

  4. 五模块设计

  粒子系统采用 5 模块架构，每个模块包含可组合的函数：

  | 模块                   | 职责      | 关键函数                                           |
  |----------------------|---------|------------------------------------------------|
  | EmitterSpawnModule   | 发射器生成配置 | -                                              |
  | EmitterUpdateModule  | 发射器每帧更新 | EmitterState, EmitterSpawnRate                 |
  | ParticleSpawnModule  | 粒子初始化   | InitializeParticle, AddVelocity, ShapeLocation |
  | ParticleUpdateModule | 粒子物理/动画 | Drag, GravityForce, CurlNoiseForce, ScaleColor |
  | ParticleRenderModule | 渲染配置    | Sprite                                         |

  5. 生命周期流程

  ParticleSystem::tick()
      ├── ParticleContext 更新系统状态
      │
      └── 对每个 ParticleEmitter:
          ├── emitter_update()    → 更新发射器状态，计算需要生成的粒子数
          ├── particle_spawn()    → 创建新粒子，执行 ParticleSpawnModule 函数
          └── particle_update(dt) → 对每个粒子:
              ├── 重置 size/color 到初始值
              ├── 执行 ParticleUpdateModule 函数（力、缩放、颜色等）
              ├── velocity += force * dt
              ├── position += velocity * dt
              ├── age += dt
              └── 移除 age >= life 的粒子

  6. 参数化系统（关键设计）

  所有数值都支持多种求值模式：

  ParticleScalar (function/math/particle_scalar.h):
  - ConstantValue - 固定值
  - RandomRange - 随机范围
  - CurveScalar - 曲线驱动
  - ParticleNormalizedAge - 粒子归一化年龄 (0-1)
  - EngineDeltaTime - 帧时间

  ParticleVec3 (function/math/particle_vec3.h):
  - 同上，支持 x/y/z 独立曲线

  7. 关键功能函数

  发射形状 (ShapeLocation):
  - BoxPlane、Sphere、Cylinder、Torus

  速度模式 (AddVelocity):
  - Linear（线性）、FromPoint（径向）、InCone（锥形）

  力场 (ParticleUpdateModule):
  - Drag（阻力）、GravityForce（重力）、VortexForce（漩涡）、CurlNoiseForce（噪声）

  8. 材质集成

  material/particle/ 下有专用节点：
  - ParticleColorNode - 暴露粒子颜色给材质
  - ParticlePositionWsNode - 世界位置
  - ParticleSubUvNode - 精灵表 UV 采样

  ---
  这是一个 高度可扩展 的设计，通过函数变体（std::variant）实现组合模式，添加新效果只需实现新的函数类型，无需修改核心逻辑。
